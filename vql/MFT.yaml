name: Windows.Detection.MFT
author: Matt Green - @mgreen27
description: |
   Bulk indicator hunt over Windows.NTFS.MFT.

   This artifact is automatically generated by DetectRaptor.

reference:
  - https://github.com/mgreen27/DetectRaptor

type: CLIENT
resources:
  timeout: 9000

parameters:
   - name: DateAfter
     type: timestamp
     description: "search for events after this date. YYYY-MM-DDTmm:hh:ssZ"
   - name: DateBefore
     type: timestamp
     description: "search for events before this date. YYYY-MM-DDTmm:hh:ssZ"
   - name: IOCs
     type: csv
     default: |
        Detection,Filename,PathName,Reference
        Suspicious Location,\.(exe|dll|dit|msi|bat|rar|zip|dmp|ps1|7z)$,/Perflogs/|/ProgramData/|/Users/Public|/Windows/Temp|Appdata/Roaming/|Appdata/Local/|C:/Temp/,Internal
        Suspicious One Letter Filename,^\w\.(exe|dll|dit|msi|bat|rar|zip|dmp|ps1|7z)$,.,
        Mimikatz Path,.,mimikatz,https://github.com/gentilkiwi/mimikatz
        Mimikatz Tools,mimikatz|mimidrv\.sys|mimilib\.dll|mimilove\.exe|mimispool\.dll|Mimikittenz|pypykatz|\.kirbi$,.,https://github.com/gentilkiwi/mimikatz
        Enumeration Tools,^(AdFind.exe|everything.exe|sharphound|bloodhound|nbtscan|Nmap.exe|Zenmap|KPortScan|Advanced_port_scanner|Advanced_ip_scanner|netscan.exe|nsscan.exe|ipscan.exe),.,Internal
        Enumeration Tool outputs,(^(ad_ous|ad_computers|ad_users|ad_group|trustdmp|subnets)\.txt)|(_computers|_domains|_gpos|_groups|_ous|_users)\.json|bloodhound\.zip|ADRecon-Report-,.,Internal
        Data Transfer Paths,.,(rclone|megasync|megaclient|MEGA.exe|plink.exe|FileZilla|ngrok|StealBit),Internal
        Data Transfer,^(rclone|megasync|megaclient|plink.exe|ngrok|StealBit),.,Internal
        Archive Utilities,^(WinRAR|7zip.exe|7z.exe),.,Internal
        Credential Theft,^(rubeus\.exe|sekurLSA.dll|WebBrowserPassView|WirelessKeyView|GrabChrome|NLBrute|veaam.ps1$|lsass.*\.(dmp|zip|rar)|pwdump|procdump),.,Internal
        Defense Evasion Paths,.,IObit Unlocker|File Shredder|DefenderControl|processhacker|pchunter|CleanWipe|DefenderControl,Internal
        Defense Evasion Binaries,^(gmer.exe|dControl.exe$|processhacker|file_shredder|pchunter|processhacker|CleanWipe|DefenderControl|nssm.exe$),.,Internal
        Encryption,^(dcrypt|truecrypt|VeraCrypt),.,Internal
        Crytominers,^WinRing0.sys$|^xmrig.exe$,.,Internal
        Execution,.,/Windows/(PAEXE|PSEXE|WinExeSvc),Internal
        Execution Tool,^(nsudo|nircmd)\.exe,.,Internal
        Pirating Software,.,KMSPico|cracked|keygen,Internal
        VPN,.,nordvpn|protonvpn|expressvpn|surfshark|cyberghost|Private Internet Access|IPvanish|wireguard|Connectify|OpenVPN,Internal
        RMM,.,action1|anydesk|/atera|awesun|Basecamp|BeAnywhere|BeyondTrust Remote|bomgar|connectwise|Domotz|DWservice|emco remote|Fixmeit|Fleetdeck|GoToAssist|Itarian|Level.io|logmein|ManageEngine|Meraki Systems Manager Agent|mremoteng|N-Able|Pulseway|realvnc|screenconnect|Sorillus|splashtop|supremo|teamviewer|tightvnc|ultravnc|VNC connect|ZeroTier|zoho assist|RemoteAgent,Internal
  

sources:
  - precondition:
      SELECT OS From info() where OS = 'windows'

    query: |
      -- firsly split IOCs by path or filename focus
      LET path_focus = SELECT PathName FROM IOCs WHERE Filename =~ '^\.$|\\|\.\\|'
        GROUP BY PathName
      LET file_focus = SELECT Filename FROM IOCs WHERE NOT Filename =~ '^\.$|\\|\.\\|'
        GROUP BY Filename
      
      -- run Filename regex first as it should be very performant
      LET file_regex_hits = SELECT EntryNumber,InUse,OSPath,FileName,FileSize,IsDir, 
            Created0x10,LastModified0x10,LastRecordChange0x10,LastAccess0x10,
            Created0x30,LastModified0x30,LastRecordChange0x30,LastAccess0x30
        FROM Artifact.Windows.NTFS.MFT(
                                FileRegex=join(array=file_focus.Filename,sep='|').
                                DateBefore=DateBefore,
                                DateAfter=DateAfter )
      
      -- second pass is path regex  
      LET path_regex_hits = SELECT EntryNumber,InUse,OSPath,FileName,FileSize,IsDir, 
            Created0x10,LastModified0x10,LastRecordChange0x10,LastAccess0x10,
            Created0x30,LastModified0x30,LastRecordChange0x30,LastAccess0x30
        FROM Artifact.Windows.NTFS.MFT(
                                PathRegex=join(array=path_focus.PathName,sep='|'),
                                DateBefore=DateBefore,
                                DateAfter=DateAfter )
      
      LET hits = SELECT * from chain( a=file_regex_hits,
                                      b=path_regex_hits )
      
      -- output results and enrich with IOC data
      SELECT * FROM foreach(row=hits,query={
            SELECT 
                dict(Name=Detection,Filename=Filename,PathName=PathName) as Detection,
                EntryNumber,InUse,OSPath,FileName,FileSize,IsDir,
                dict(Created0x10=Created0x10,LastModified0x10=LastModified0x10,LastRecordChange0x10=LastRecordChange0x10,LastAccess0x10=LastAccess0x10) as SITimestamps,
                dict(Created0x30=Created0x30,LastModified0x30=LastModified0x30,LastRecordChange0x30=LastRecordChange0x30,LastAccess0x30=LastAccess0x30) as FNTimestamps
            FROM IOCs
            WHERE FileName =~ Filename
                AND OSPath =~ PathName
        },workers=20)

    notebook:
      - type: vql_suggestion
        name: Detection summary
        template: |
            /*
            ### Detection summary
            */
            
            SELECT Detection.Name, count() AS Total
            FROM source()
            GROUP BY Detection.Name
            ORDER BY Total DESC 
            
      - type: vql_suggestion
        name: Detection filter
        template: |
            /*
            ### Detection filter  
            Use this notebook to modify filter and target specific Detections.
            */
            
            SELECT Fqdn,Detection.Name,OSPath,InUse,FileSize,
                SITimestamps.Created0x10 as Created0x10,
                SITimestamps.LastModified0x10 as LastModified0x10,
                FNTimestamps.Created0x30 as Created0x30,
                FNTimestamps.LastModified0x30 as LastModified0x30
            FROM source()
            WHERE Detection.Name =~ 'Defense Evasion Binaries|RMM'
