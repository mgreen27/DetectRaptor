name: Windows.Detection.HijackLibsEnv
author: Matt Green - @mgreen27
description: |
   This artifact collects several datapoints that may indicate an Environment
   Variable based hijack.

   The artifact is automatically generated by DetectRaptor with an API extract
   of Hijacklibs.

   The artifact searches for Environment Variables (default systemroot|windir)
   associated to each process and reports if set to non default.

   The artifact also searches for a DllPath containing System32 not at an
   expected location.

   Finally the artifact searches for known EnvVariable DllNames in hijacklibs in
   unexpected locations with Export Forwards which may indicate a Hijack usecase.

   Expect some false positives, especially for disk based datapoints. Context
   fields have also been included for scoping, an intereting item to review is
   PE forwarding which may indicate a hijacked binary.


reference:
  - https://github.com/mgreen27/DetectRaptor
  - https://www.wietzebeukema.nl/blog/save-the-environment-variables
  - https://hijacklibs.net/

type: CLIENT
resources:
  timeout: 9000

parameters:
   - name: TargetEnv
     type: regex
     description: A regex to select environment variables to target
     default:  ^(systemroot|windir)$
   - name: ExpectedEnv
     type: regex
     description: Expected environment variables to filter out.
     default:  ^C:\\Windows$
   - name: SuspiciousPath
     type: regex
     description: Regex for suspicious path to search for used in Environment variable hijack.
     default:  \\System32\\
   - name: ExpectedPath
     type: regex
     description: Expected path to filter out from SuspiciousPath regex above.
     default:  ^C:\\Windows\\System32\\
   - name: AllCsv
     type: hidden
     default: |
        DllName,Vendor,ExpectedLocation,ExecutablePath,Type,ExecutableSHA256,Url
        applicationframe.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\applicationframehost\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/applicationframe.html
        bcrypt.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\shellappruntime\.exe|\\Windows\\System32\\wordpad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/bcrypt.html
        cabinet.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\logman\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/cabinet.html
        cabview.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/cabview.html
        comdlg32.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/comdlg32.html
        connect.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/connect.html
        credui.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/credui.html
        cscobj.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/cscobj.html
        cscui.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/cscui.html
        dataexchange.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\charmap\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\wordpad\.exe|\\Program Files( \(x86\))?\\Google\\Chrome\\Application\\chrome\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft\\EdgeWebView\\Application\\[^\\]+\\msedgewebview2\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/dataexchange.html
        davclnt.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\msdt\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\powershell\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\tabcal\.exe|\\Windows\\System32\\verifier\.exe|\\Windows\\System32\\workfolders\.exe|\\Windows\\System32\\write\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/davclnt.html
        dbghelp.dll,Microsoft,\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\arm|\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\arm\\srcsrv|\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\arm64|\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\arm64\\srcsrv|\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\x64|\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\x64\\srcsrv|\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\x86|\\Program Files( \(x86\))?\\windows kits\\10\\debuggers\\x86\\srcsrv|\\Program Files( \(x86\))?\\cisco systems\\cisco jabber|\\Program Files( \(x86\))?\\microsoft office\\root\\office[^\\]+|\\Program Files( \(x86\))?\\microsoft office\\root\\vfs\\programfilesx86\\microsoft analysis services\\as oledb\\140|\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\bdehdcfg\.exe|\\Windows\\System32\\deploymentcsphelper\.exe|\\Windows\\System32\\djoin\.exe|\\Windows\\System32\\dnscacheugc\.exe|\\Windows\\System32\\ieunatt\.exe|\\Windows\\System32\\muiunattend\.exe|\\Windows\\System32\\netbtugc\.exe|\\Windows\\System32\\netiougc\.exe|\\Windows\\System32\\pnpunattend\.exe|\\Windows\\System32\\reagentc\.exe|\\Windows\\System32\\setupugc\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/dbghelp.html
        defragproxy.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\dfrgui\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/defragproxy.html
        desktopshellext.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\sihost\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/desktopshellext.html
        devicepairing.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\devicepairingwizard\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/devicepairing.html
        directmanipulation.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excelcnv\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/directmanipulation.html
        drprov.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\msdt\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\powershell\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\tabcal\.exe|\\Windows\\System32\\verifier\.exe|\\Windows\\System32\\workfolders\.exe|\\Windows\\System32\\write\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/drprov.html
        dsrole.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\filehistory\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/dsrole.html
        dui70.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/dui70.html
        eappcfg.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/eappcfg.html
        efsutil.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\filehistory\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/efsutil.html
        execmodelproxy.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\calc\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/execmodelproxy.html
        explorerframe.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\control\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\filehistory\.exe|\\Windows\\System32\\mstsc\.exe|\\Windows\\System32\\notepad\.exe|\\Program Files( \(x86\))?\\Google\\Chrome\\Application\\chrome\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/explorerframe.html
        fastprox.dll,Microsoft,\\Windows\\System32\\wbem|\\Windows\\SysWOW64\\wbem,\\Windows\\System32\\cttune\.exe|\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\driverquery\.exe|\\Windows\\System32\\getmac\.exe|\\Windows\\System32\\licensingdiag\.exe|\\Windows\\System32\\msinfo32\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\systeminfo\.exe|\\Windows\\System32\\tasklist\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excelcnv\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\scanpst\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/fastprox.html
        fddevquery.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\ddodiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/fddevquery.html
        fhcfg.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\filehistory\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/fhcfg.html
        flightsettings.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\devicecensus\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/flightsettings.html
        fwpuclnt.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\stordiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/fwpuclnt.html
        idstore.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\shellappruntime\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/idstore.html
        iphlpapi.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\dpiscaling\.exe|\\Windows\\System32\\rasphone\.exe|\\Windows\\System32\\slui\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/iphlpapi.html
        isv.exe_rsaenh.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rmactivate,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/isv.exe_rsaenh.html
        licensingdiagspp.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\licensingdiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/licensingdiagspp.html
        logoncontroller.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\logonui\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/logoncontroller.html
        lpksetupproxyserv.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\lpksetup\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/lpksetupproxyserv.html
        mlang.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/mlang.html
        mmdevapi.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\mblctr\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\presentationsettings\.exe|\\Windows\\System32\\sndvol\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/mmdevapi.html
        mpr.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\filehistory\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/mpr.html
        msctf.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\conhost\.exe|\\Windows\\System32\\filehistory\.exe|\\Windows\\System32\\mstsc\.exe|\\Windows\\System32\\wordpad\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\Program Files( \(x86\))?\\Microsoft\\EdgeWebView\\Application\\[^\\]+\\msedgewebview2\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/msctf.html
        mswb7.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\control\.exe|\\Windows\\System32\\explorer\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/mswb7.html
        mswsock.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\curl\.exe|\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\ftp\.exe|\\Windows\\System32\\hostname\.exe|\\Windows\\System32\\nslookup\.exe|\\Windows\\System32\\rpcping\.exe|\\Windows\\System32\\stordiag\.exe|\\Program Files( \(x86\))?\\Google\\Chrome\\Application\\chrome\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\(Users\\[^\\]+|windows\\(System32|SysWOW64)\\config\\systemprofile)\\AppData\\[^\\]+\\Zoom\\bin\\zoom\.exe|\\Program Files( \(x86\))?\\WindowsApps\\MicrosoftTeams[^\\]+\\msteams\.exe|\\Program Files( \(x86\))?\\Microsoft\\EdgeWebView\\Application\\[^\\]+\\msedgewebview2\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\scanpst\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\sdxhelper\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/mswsock.html
        msxml3.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\wordpad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/msxml3.html
        napinsp.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\ftp\.exe|\\Windows\\System32\\hostname\.exe|\\Windows\\System32\\stordiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/napinsp.html
        ncrypt.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\filehistory\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/ncrypt.html
        ndfapi.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\dpiscaling\.exe|\\Windows\\System32\\slui\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/ndfapi.html
        netprofm.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\fxscover\.exe|\\Windows\\System32\\rdpclip\.exe|\\Windows\\System32\\wordpad\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\Program Files( \(x86\))?\\WindowsApps\\MicrosoftTeams[^\\]+\\msteams\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\clview\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\cnfnot32\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excelcnv\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\graph\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msoia\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msosrec\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msqry32\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\namecontrolserver\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\protocolhandler\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\scanpst\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\sdxhelper\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\setlang\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/netprofm.html
        netsetupapi.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/netsetupapi.html
        netshell.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/netshell.html
        networkexplorer.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/networkexplorer.html
        nlansp_c.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\ftp\.exe|\\Windows\\System32\\hostname\.exe|\\Windows\\System32\\stordiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/nlansp_c.html
        npmproxy.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\apphostregistrationverifier\.exe|\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\directxdatabaseupdater\.exe|\\Windows\\System32\\fxscover\.exe|\\Windows\\System32\\microsoft\.uev\.synccontroller\.exe|\\Windows\\System32\\rdpclip\.exe|\\Windows\\System32\\wordpad\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\clview\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\cnfnot32\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excelcnv\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\graph\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msoia\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msosrec\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msqry32\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\namecontrolserver\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\protocolhandler\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\scanpst\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\sdxhelper\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\setlang\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/npmproxy.html
        ntlanman.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\msdt\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\powershell\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\tabcal\.exe|\\Windows\\System32\\verifier\.exe|\\Windows\\System32\\workfolders\.exe|\\Windows\\System32\\write\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/ntlanman.html
        ntmarta.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Program Files( \(x86\))?\\Google\\Chrome\\Application\\chrome\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft\\EdgeWebView\\Application\\[^\\]+\\msedgewebview2\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/ntmarta.html
        ntshrui.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/ntshrui.html
        p9np.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\msdt\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\powershell\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\tabcal\.exe|\\Windows\\System32\\verifier\.exe|\\Windows\\System32\\workfolders\.exe|\\Windows\\System32\\write\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/p9np.html
        pdh.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\logman\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/pdh.html
        pla.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\logman\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/pla.html
        pnrpnsp.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\ftp\.exe|\\Windows\\System32\\hostname\.exe|\\Windows\\System32\\stordiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/pnrpnsp.html
        propsys.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\cleanmgr\.exe|\\Windows\\System32\\control\.exe|\\Windows\\System32\\ddodiag\.exe|\\Windows\\System32\\dfrgui\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\fxscover\.exe|\\Windows\\System32\\licensingdiag\.exe|\\Windows\\System32\\msdt\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\powershell\.exe|\\Windows\\System32\\presentationsettings\.exe|\\Windows\\System32\\tabcal\.exe|\\Windows\\System32\\verifier\.exe|\\Program Files( \(x86\))?\\Google\\Chrome\\Application\\chrome\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe|\\(Users\\[^\\]+|windows\\(System32|SysWOW64)\\config\\systemprofile)\\AppData\\[^\\]+\\Zoom\\bin\\zoom\.exe|\\Program Files( \(x86\))?\\WindowsApps\\MicrosoftTeams[^\\]+\\msteams\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\graph\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msoev\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msotd\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/propsys.html
        rasgcw.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/rasgcw.html
        rsaenh.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\disksnapshot\.exe|\\Windows\\System32\\filehistory\.exe|\\Windows\\System32\\licensingdiag\.exe|\\Windows\\System32\\lpksetup\.exe|\\Windows\\System32\\microsoft\.uev\.synccontroller\.exe|\\Windows\\System32\\phoneactivate\.exe|\\Windows\\System32\\powershell\.exe|\\Windows\\System32\\rmactivate\.exe|\\Windows\\System32\\scriptrunner\.exe|\\Windows\\System32\\sppextcomobj\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\tzsync\.exe|\\Windows\\System32\\uevappmonitor\.exe|\\Windows\\System32\\useraccountcontrolsettings\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\(Users\\[^\\]+|windows\\(System32|SysWOW64)\\config\\systemprofile)\\AppData\\[^\\]+\\Zoom\\bin\\zoom\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msoadfsb\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\namecontrolserver\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/rsaenh.html
        sapi_onecore.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\devicecensus\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/sapi_onecore.html
        shell32.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\control\.exe|\\Windows\\System32\\dpiscaling\.exe|\\Windows\\System32\\mobsync\.exe|\\Windows\\System32\\mstsc\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\presentationsettings\.exe|\\Windows\\System32\\shellappruntime\.exe|\\Windows\\System32\\wallpaperhost\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/shell32.html
        ssp.exe_rsaenh.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rmactivate,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/ssp.exe_rsaenh.html
        ssp_isv.exe_rsaenh.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rmactivate,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/ssp_isv.exe_rsaenh.html
        sspicli.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/sspicli.html
        structuredquery.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\control\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/structuredquery.html
        twext.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\compmgmtlauncher\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/twext.html
        twinapi.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\rasphone\.exe|\\Windows\\System32\\rdpclip\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/twinapi.html
        twinui.appcore.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\calc\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/twinui.appcore.html
        uianimation.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\cloudnotifications\.exe|\\Windows\\System32\\gamepanel\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/uianimation.html
        uiribbon.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\wordpad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/uiribbon.html
        wbemprox.dll,Microsoft,\\Windows\\System32\\wbem|\\Windows\\SysWOW64\\wbem,\\Windows\\System32\\cttune\.exe|\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\driverquery\.exe|\\Windows\\System32\\getmac\.exe|\\Windows\\System32\\gpresult\.exe|\\Windows\\System32\\licensingdiag\.exe|\\Windows\\System32\\msinfo32\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\systeminfo\.exe|\\Windows\\System32\\taskkill\.exe|\\Windows\\System32\\tasklist\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excelcnv\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\scanpst\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wbemprox.html
        wbemsvc.dll,Microsoft,\\Windows\\System32\\wbem|\\Windows\\SysWOW64\\wbem,\\Windows\\System32\\cttune\.exe|\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\driverquery\.exe|\\Windows\\System32\\getmac\.exe|\\Windows\\System32\\licensingdiag\.exe|\\Windows\\System32\\msinfo32\.exe|\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\systeminfo\.exe|\\Windows\\System32\\tasklist\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excelcnv\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\scanpst\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wbemsvc.html
        wdi.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\dpiscaling\.exe|\\Windows\\System32\\slui\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wdi.html
        wevtapi.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\filehistory\.exe|\\Windows\\System32\\logman\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wevtapi.html
        windows.storage.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\calc\.exe|\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\control\.exe|\\Windows\\System32\\dfrgui\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\filehistory\.exe|\\Windows\\System32\\licensingdiag\.exe|\\Windows\\System32\\msdt\.exe|\\Windows\\System32\\mstsc\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\powershell\.exe|\\Windows\\System32\\presentationsettings\.exe|\\Windows\\System32\\rdpclip\.exe|\\Windows\\System32\\tabcal\.exe|\\Windows\\System32\\verifier\.exe|\\Windows\\System32\\wfs\.exe|\\Windows\\System32\\workfolders\.exe|\\Windows\\System32\\write\.exe|\\Windows\\System32\\wscollect\.exe|\\Program Files( \(x86\))?\\Google\\Chrome\\Application\\chrome\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\(Users\\[^\\]+|windows\\(System32|SysWOW64)\\config\\systemprofile)\\AppData\\[^\\]+\\Zoom\\bin\\zoom\.exe|\\Program Files( \(x86\))?\\WindowsApps\\MicrosoftTeams[^\\]+\\msteams\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msoev\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msotd\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\onenote\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/windows.storage.html
        windows.storage.search.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\control\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/windows.storage.search.html
        windowscodecs.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\dfrgui\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\filehistory\.exe|\\Windows\\System32\\gamepanel\.exe|\\Windows\\System32\\mstsc\.exe|\\Windows\\System32\\notepad\.exe|\\Windows\\System32\\presentationsettings\.exe|\\Windows\\System32\\wfs\.exe|\\Windows\\System32\\winver\.exe|\\Windows\\System32\\wordpad\.exe|\\Windows\\System32\\wscollect\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\excel\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\outlook\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\powerpnt\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\winword\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\msaccess\.exe|\\Program Files( \(x86\))?\\Microsoft Office\\root\\Office[^\\]+\\mspub\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/windowscodecs.html
        windowscodecsext.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\wfs\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/windowscodecsext.html
        windowsudk.shellcommon.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\explorer\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/windowsudk.shellcommon.html
        winrnr.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\ftp\.exe|\\Windows\\System32\\hostname\.exe|\\Windows\\System32\\stordiag\.exe|\\Program Files( \(x86\))?\\Mozilla Firefox\\firefox\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/winrnr.html
        wlidprov.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\devicecensus\.exe|\\Windows\\System32\\shellappruntime\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wlidprov.html
        wmidcom.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\stordiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wmidcom.html
        wmiutils.dll,Microsoft,\\Windows\\System32\\wbem|\\Windows\\SysWOW64\\wbem,\\Windows\\System32\\stordiag\.exe|\\Windows\\System32\\tasklist\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wmiutils.html
        wpdshext.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\certreq\.exe|\\Windows\\System32\\notepad\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wpdshext.html
        wshbth.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\ftp\.exe|\\Windows\\System32\\hostname\.exe|\\Windows\\System32\\stordiag\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/wshbth.html
        xmllite.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\compmgmtlauncher\.exe|\\Windows\\System32\\explorer\.exe|\\Windows\\System32\\filehistory\.exe|\\Program Files( \(x86\))?\\Microsoft\\Edge\\Application\\msedge\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/xmllite.html
        xwizards.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\devicepairingwizard\.exe|\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/xwizards.html
        xwtpw32.dll,Microsoft,\\Windows\\System32|\\Windows\\SysWOW64,\\Windows\\System32\\devicepairingwizard\.exe|\\Windows\\System32\\rasphone\.exe,Environment Variable,,https://hijacklibs.net/entries/microsoft/built-in/xwtpw32.html



sources:
  - precondition:
      SELECT OS From info() where OS = 'windows'

    name: Process Environment Variables
    query: |
      SELECT * FROM Artifact.Windows.Detection.EnvironmentVariables(
                EnvironmentVariableRegex=TargetEnv,
                FilterValueRegex='.',
                WhitelistValueRegex=if(condition=ExpectedEnv,
                                        then=ExpectedEnv,
                                        else='$^^$')
            )


  - name: Suspicious Dll path
    query: |
      LET IocCsv <= SELECT * FROM parse_csv(filename=AllCsv,accessor='data')

      LET hits = SELECT
            InUse,
            format(format='C:\\%s',args=OSPath) as OSPath,
            FileName, FileSize,SI_Lt_FN,uSecZeros,
            LastModified0x10,LastAccess0x10,LastRecordChange0x10,Created0x10,
            LastModified0x30,LastAccess0x30,LastRecordChange0x30,Created0x30
      FROM parse_mft(filename='C:/$MFT')
      WHERE NOT IsDir
        AND FileName =~ '\.dll$'
        AND OSPath =~ SuspiciousPath --'''\\System32\\'''
        AND NOT OSPath =~ ExpectedPath --'''^C:\\Windows\\System32'''

      LET enrich_ioc(filename) = SELECT * FROM IocCsv WHERE DllName = filename

      SELECT
            OSPath, FileName as DllName,
            FileSize,InUse, SI_Lt_FN, uSecZeros,
            dict(
                LastModified0x10=LastModified0x10,
                LastAccess0x10=LastAccess0x10,
                LastRecordChange0x10=LastRecordChange0x10,
                Created0x10=Created0x10 ) AS TimestampsSI,
            dict(
                LastModified0x30=LastModified0x30,
                LastAccess0x30=LastAccess0x30,
                LastRecordChange0x30=LastRecordChange0x30,
                Created0x30=Created0x30 ) AS TimestampsFN,
            parse_pe(file=OSPath) AS DllInfo,
            authenticode(filename=OSPath) AS DllAuthenticode,
            hash(path=OSPath) as DllHash,
            enrich_ioc(filename=FileName)[0] as HijackLib,
            { SELECT OSPath FROM glob(root=dirname(path=OSPath),globs='*')} as Folder
      FROM hits


  - name: Find Dll forwards
    query: |
      -- yara pe module is most performant way to find DLLs with forward exports.
      LET ForwardsYaraRule = '''import "pe"
        rule Has_Export_Forwarders {
            condition:
                for any forwarder in pe.export_details: (forwarder.forward_name != "YR_UNDEFINED")
        }
        '''

      LET IocCsv <= SELECT * FROM parse_csv(filename=AllCsv,accessor='data')
      LET files = SELECT
            EntryNumber,InUse,ParentEntryNumber,
            format(format='C:\\%s',args=OSPath) as OSPath,
            FileName as DllName, FileSize,SI_Lt_FN,uSecZeros,
            LastModified0x10,LastAccess0x10,LastRecordChange0x10,Created0x10,
            LastModified0x30,LastAccess0x30,LastRecordChange0x30,Created0x30
        FROM parse_mft(filename='C:/$MFT')
        WHERE InUse and NOT IsDir
            AND FileName in IocCsv.DllName
            --AND FileName =~ '\.dll$'
            AND NOT OSPath =~ '''^C:\\(Windows\\(System32|SysWOW64|WinSxS|Microsoft\.NET|assembly|SoftwareDistribution)|\<Err\>)\\'''
            AND NOT OSPath =~ '''\\(Microsoft.NET.Native.Runtime|Microsoft.NETCore.App\\)|\\Program Files( \(x86\))?\\(Microsoft Visual Studio|WindowsApps\\Microsoft)'''

      LET enrich_ioc(filename) = SELECT * FROM IocCsv WHERE DllName = filename

      SELECT
        OSPath, DllName,FileSize,InUse, SI_Lt_FN,uSecZeros,
            dict(
                LastModified0x10=LastModified0x10,
                LastAccess0x10=LastAccess0x10,
                LastRecordChange0x10=LastRecordChange0x10,
                Created0x10=Created0x10 ) AS TimestampsSI,
            dict(
                LastModified0x30=LastModified0x30,
                LastAccess0x30=LastAccess0x30,
                LastRecordChange0x30=LastRecordChange0x30,
                Created0x30=Created0x30 ) AS TimestampsFN,
            parse_pe(file=OSPath) AS DllInfo,
            authenticode(filename=OSPath) as DllAuthenticode,
            hash(path=OSPath) as DllHash,
            enrich_ioc(filename=DllName)[0] as HijackLib,
            { SELECT OSPath FROM glob(root=dirname(path=OSPath),globs='*')} as Folder
          FROM foreach(row=files,
                query={
                    SELECT
                        OSPath,
                        DllName, FileSize,InUse,SI_Lt_FN,uSecZeros,
                        LastModified0x10,LastAccess0x10,LastRecordChange0x10,Created0x10,
                        LastModified0x30,LastAccess0x30,LastRecordChange0x30,Created0x30
                    FROM yara(rules=ForwardsYaraRule, files=OSPath)
                })
